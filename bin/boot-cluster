#!/bin/bash

sed -i '
	/172.16.10/d
	/10.243.28/d
	' $HOME/.ssh/known_hosts

echo "Booting master."
nova boot --image=fedora-17-x86_64-3 \
	--flavor=m1.medium \
	--user_data playbooks/files/master/userdata \
	--key_name lars_madhatter \
	--poll \
	lars-master

echo "Assigning master ip."
nova add-floating-ip lars-master 10.243.28.34

echo "Booting nodes."
for x in 0 1 2 3; do
	echo "  Booting node $x."
	nova boot --image=fedora-17-x86_64-minimal \
		--flavor=m1.small \
		--user_data playbooks/files/minions/userdata \
		--key_name lars_madhatter \
		lars-node-$x > /dev/null 2>&1 &
	server_names="$server_names lars-node-$x"
done

# Wait for boot processes to exit.
wait

echo "Waiting for instances."
./bin/nova-wait-active $server_names

make clean
make

